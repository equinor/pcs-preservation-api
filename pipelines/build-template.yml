parameters:
  deploymentName: ''
  dependsOn: ''
  env: ''
  serviceConnection: ''

jobs:
- deployment: ${{ parameters.deploymentName }}
  dependsOn: ${{ parameters.dependsOn }}
  displayName: '${{ parameters.deploymentName }}'
  pool: 
    vmImage: '$(vmImageName)'
  environment: '${{ parameters.env }}'
  strategy:
    runOnce:
      deploy:
        steps:
        - checkout: self
        - task: DockerCompose@0
          displayName: Build
          inputs:
            action: Build services
            azureSubscriptionEndpoint: ${{ parameters.serviceConnection }}
            azureContainerRegistry: '${{ variables.containerRegistry }}'
            dockerComposeFile: '$(Build.SourcesDirectory)${{ variables.composeFilePath }}'
            additionalImageTags: $(Build.BuildId)

        - task: DockerCompose@0
          displayName: Push services
          inputs:
            action: Push services
            azureSubscriptionEndpoint: ${{ parameters.serviceConnection }}
            azureContainerRegistry: '${{ variables.containerRegistry }}'
            dockerComposeFile: '$(Build.SourcesDirectory)${{ variables.composeFilePath }}'
            projectName: '${{ variables.projectName }}/$(Build.Repository.Name)'
            qualifyImageNames: true
            additionalImageTags: $(Build.BuildId)